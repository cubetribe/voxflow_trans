#!/bin/bash

# VoxFlow Development Startup Script
# This script starts the complete VoxFlow stack in Docker containers

set -e

# Wechsle ins Script-Verzeichnis (wichtig f√ºr relative Pfade)
cd "$(dirname "$0")"

echo "üéôÔ∏è  VoxFlow - AI Voice Transcription Platform"
echo "============================================="
echo ""
echo "ü§ñ Was ist VoxFlow?"
echo "   ‚Ä¢ Professionelle KI-basierte Audio-Transkription"
echo "   ‚Ä¢ Powered by Mistral's Voxtral-Mini-3B-2507 Model"
echo "   ‚Ä¢ Optimiert f√ºr Apple Silicon (M1/M2/M3/M4)"
echo "   ‚Ä¢ Unterst√ºtzt: MP3, WAV, M4A, WEBM, OGG, FLAC"
echo "   ‚Ä¢ Batch-Verarbeitung bis 500MB pro Datei"
echo ""
echo "üèóÔ∏è  Architektur:"
echo "   üêç Python Service (Port 8000) - Voxtral AI Model"
echo "   üü¢ Node.js Gateway (Port 3000) - API & WebSocket"
echo "   ‚öõÔ∏è  React Frontend (Port 5173) - Web Interface"
echo "   üî¥ Redis Cache (Port 6379) - Performance"
echo ""

# DEBUG-MODUS ABFRAGE
read -p "üîß Debug-Modus aktivieren? (y/n): " DEBUG_MODE
if [[ $DEBUG_MODE == "y" || $DEBUG_MODE == "Y" ]]; then
    echo "üêõ DEBUG-MODUS AKTIV - Detaillierte Logs werden angezeigt"
    DEBUG_ENABLED=true
    set -x  # Bash debug f√ºr Commands
else
    DEBUG_ENABLED=false
fi

echo ""
echo "üöÄ Starting VoxFlow Development Environment"
echo "=========================================="

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "‚ùå Docker is not running. Please start Docker Desktop."
    exit 1
fi

# DETAILLIERTE SYSTEM-INFORMATIONEN (im Debug-Modus)
if [[ $DEBUG_ENABLED == true ]]; then
    echo ""
    echo "üîç SYSTEM-INFORMATIONEN:"
    echo "   macOS: $(sw_vers -productVersion)"
    echo "   Docker: $(docker --version)"
    echo "   Verf√ºgbarer RAM: $(sysctl hw.memsize | awk '{print int($2/1024/1024/1024)}')GB"
    echo "   CPU Kerne: $(sysctl hw.ncpu | awk '{print $2}')"
    echo ""
    
    echo "üîç VERZEICHNIS-CHECKS:"
    echo "   Aktuelles Verzeichnis: $(pwd)"
    if [ -d "frontend_new/project" ]; then
        echo "   ‚úÖ Frontend: frontend_new/project/ gefunden"
    else
        echo "   ‚ùå Frontend: frontend_new/project/ NICHT gefunden"
        echo "   üìÇ Verf√ºgbare Verzeichnisse:"
        ls -la | grep "^d" | awk '{print "      " $9}' || true
    fi
    
    if [ -d "backend/node-service" ]; then
        echo "   ‚úÖ Node.js Service: backend/node-service/ gefunden"
    else
        echo "   ‚ùå Node.js Service: backend/node-service/ NICHT gefunden"
    fi
    
    if [ -d "backend/python-service" ]; then
        echo "   ‚úÖ Python Service: backend/python-service/ gefunden"
    else
        echo "   ‚ùå Python Service: backend/python-service/ NICHT gefunden"
    fi
    
    if [ -f "docker-compose.yml" ]; then
        echo "   ‚úÖ Docker Compose: docker-compose.yml gefunden"
    else
        echo "   ‚ùå Docker Compose: docker-compose.yml NICHT gefunden"
        echo "   üìÇ Verf√ºgbare Dateien:"
        ls -la *.yml 2>/dev/null | awk '{print "      " $9}' || echo "      Keine .yml Dateien gefunden"
    fi
    echo ""
fi

# Create environment files if they don't exist
echo "üìù Setting up environment files..."

# Frontend environment - check if directory exists first
if [ ! -d "frontend_new/project" ]; then
    echo "‚ùå Frontend directory 'frontend_new/project' not found!"
    echo "   Expected: frontend_new/project/"
    echo "   Please check your project structure."
    exit 1
fi

# Frontend environment
if [ ! -f frontend_new/project/.env.local ]; then
    # Create .env.local with default values since .env.example might not exist
    cat > frontend_new/project/.env.local << EOF
VITE_API_URL=http://localhost:3000
VITE_WS_URL=ws://localhost:3000
VITE_MAX_FILE_SIZE=500
VITE_CHUNK_SIZE=32
EOF
    echo "‚úÖ Created frontend_new/project/.env.local"
fi

# Node.js service environment - check if directory exists first
if [ ! -d "backend/node-service" ]; then
    echo "‚ùå Node.js service directory 'backend/node-service' not found!"
    echo "   Expected: backend/node-service/"
    echo "   Please check your project structure."
    exit 1
fi

if [ ! -f backend/node-service/.env ]; then
    cat > backend/node-service/.env << EOF
PORT=3000
REDIS_URL=redis://redis:6379
DATABASE_URL=sqlite:./data/voxflow.db
PYTHON_SERVICE_URL=http://python-service:8000
JWT_SECRET=dev-secret-key-change-in-production
NODE_ENV=development
EOF
    echo "‚úÖ Created backend/node-service/.env"
fi

# Python service environment - check if directory exists first
if [ ! -d "backend/python-service" ]; then
    echo "‚ùå Python service directory 'backend/python-service' not found!"
    echo "   Expected: backend/python-service/"
    echo "   Please check your project structure."
    exit 1
fi

if [ ! -f backend/python-service/.env ]; then
    cat > backend/python-service/.env << EOF
PORT=8000
MODEL_NAME=mistralai/Voxtral-Mini-3B-2507
DEVICE=mps
MAX_AUDIO_LENGTH=1800
CHUNK_SIZE=30
REDIS_URL=redis://redis:6379
ENVIRONMENT=development
EOF
    echo "‚úÖ Created backend/python-service/.env"
fi

echo ""
echo "üê≥ Starting Docker containers..."
echo "This may take a few minutes on first run..."

# Check if docker-compose.yml exists
if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå docker-compose.yml not found in current directory!"
    echo "   Expected: docker-compose.yml"
    echo "   Current directory: $(pwd)"
    echo "   Available compose files:"
    ls -la docker-compose*.yml 2>/dev/null || echo "   No docker-compose files found"
    exit 1
fi

# Erweiterte Build-Logik - Requirements-√Ñnderungen erkennen
echo "üîç Pr√ºfe ob Images neu gebaut werden m√ºssen..."

# Check 1: Existieren Images √ºberhaupt?
if ! docker images | grep -q "voxflow_traskriber"; then
    echo "üèóÔ∏è Erste Installation - Building alle Images..."
    docker-compose build --no-cache
    
# Check 2: Dependencies ge√§ndert? (requirements-docker.txt neuer als Image)
elif [ "backend/python-service/requirements-docker.txt" -nt "$(docker images --format "table {{.CreatedAt}}" voxflow_traskriber-python-service | tail -n +2 | head -1)" ] 2>/dev/null; then
    echo "üì¶ Requirements ge√§ndert - Rebuilding Python Service..."
    docker-compose build --no-cache python-service
    
# Check 3: Dockerfile ge√§ndert?
elif [ "backend/python-service/Dockerfile" -nt "$(docker images --format "table {{.CreatedAt}}" voxflow_traskriber-python-service | tail -n +2 | head -1)" ] 2>/dev/null; then
    echo "üê≥ Dockerfile ge√§ndert - Rebuilding Python Service..."
    docker-compose build --no-cache python-service
    
else
    echo "‚úÖ Images sind aktuell - kein Build erforderlich"
fi

# Stoppe alte Container falls vorhanden
echo "üõë Stoppe laufende Container..."
docker-compose down 2>/dev/null || true

# Starte Services
echo "üöÄ Starte VoxFlow Services..."
docker-compose up -d

# ERWEITERTE PYTHON SERVICE DEBUG INFO
echo ""
echo "üîç Checking Python Service Status..."
sleep 5

# Container Status
echo ""
echo "üìã Container Status:"
docker-compose ps python-service

# Die letzten 50 Logs
echo ""
echo "üìã Python Service Logs (Last 50 lines):"
docker-compose logs python-service --tail=50

# Speziell nach Errors suchen
echo ""
echo "‚ùå Error Details:"
docker-compose logs python-service --tail=100 | grep -E "ERROR|KeyError|Failed|Exception|Traceback" || echo "No specific errors found"

# Health Check Detail
echo ""
echo "üè• Health Check Details:"
docker inspect $(docker-compose ps -q python-service) --format='{{json .State.Health}}' 2>/dev/null | jq '.' 2>/dev/null || echo "No health check info available"

# Container Resource Usage
echo ""
echo "üìä Container Resource Usage:"
docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}" | grep python-service || echo "No stats available"

# Network Connectivity Test
echo ""
echo "üåê Network Connectivity Test:"
docker exec $(docker-compose ps -q python-service) curl -f http://localhost:8000/health 2>/dev/null && echo "‚úÖ Internal health check OK" || echo "‚ùå Internal health check FAILED"

# Environment Variables Check
if [[ $DEBUG_ENABLED == true ]]; then
    echo ""
    echo "üîß Environment Variables:"
    docker exec $(docker-compose ps -q python-service) env | grep -E "MODEL_NAME|DEVICE|PORT|REDIS_URL" || echo "No relevant env vars found"
fi

echo ""
echo "‚è≥ Waiting for services to become healthy..."

# ERWEITERTE SERVICE-CHECKS MIT DEBUG
check_service() {
    local service=$1
    local url=$2
    local timeout=60
    local count=0
    
    while [ $count -lt $timeout ]; do
        if curl -s -f "$url" > /dev/null 2>&1; then
            if [[ $DEBUG_ENABLED == true ]]; then
                response_time=$(curl -s -w "%{time_total}" -o /dev/null "$url")
                echo "‚úÖ $service bereit (${response_time}s Response-Zeit)"
            else
                echo "‚úÖ $service bereit"
            fi
            return 0
        fi
        
        if [[ $DEBUG_ENABLED == true && $((count % 5)) -eq 0 && $count -gt 0 ]]; then
            echo "   üîÑ $service: Versuch $count/$timeout..."
            # Container Status anzeigen
            docker-compose ps $service 2>/dev/null | tail -n +2 || true
        fi
        
        sleep 2
        count=$((count + 1))
        if [[ $DEBUG_ENABLED == false ]]; then
            printf "."
        fi
    done
    
    echo "‚ùå $service Timeout nach ${timeout}s"
    if [[ $DEBUG_ENABLED == true ]]; then
        echo "üîß Debug-Logs f√ºr $service:"
        docker-compose logs --tail=10 $service 2>/dev/null || true
    fi
    return 1
}

# Check Redis
echo -n "üî¥ Checking Redis..."
if ! check_service "Redis" "http://localhost:6379"; then
    echo "Failed to connect to Redis"
    exit 1
fi

# Check Python Service
echo -n "üêç Checking Python Service..."
if ! check_service "Python Service" "http://localhost:8000/health"; then
    echo "Failed to connect to Python Service"
    docker-compose logs python-service
    exit 1
fi

# Check Node.js Service
echo -n "üü¢ Checking Node.js Service..."
if ! check_service "Node.js Service" "http://localhost:3000/health"; then
    echo "Failed to connect to Node.js Service"
    docker-compose logs node-service
    exit 1
fi

# Check Frontend
echo -n "‚öõÔ∏è  Checking Frontend..."
if ! check_service "Frontend" "http://localhost:5173"; then
    echo "Failed to connect to Frontend"
    docker-compose logs frontend
    exit 1
fi

echo ""
echo "üéâ VoxFlow erfolgreich gestartet!"
echo ""
echo "üåê VERF√úGBARE SERVICES:"
echo "   ‚îå‚îÄ Frontend (Web-Interface)"
echo "   ‚îÇ  ‚îî‚îÄ‚îÄ http://localhost:5173"
echo "   ‚îú‚îÄ API Gateway (REST + WebSocket)"  
echo "   ‚îÇ  ‚îî‚îÄ‚îÄ http://localhost:3000"
echo "   ‚îú‚îÄ Python AI Service (Voxtral Model)"
echo "   ‚îÇ  ‚îî‚îÄ‚îÄ http://localhost:8000"
echo "   ‚îî‚îÄ Redis Cache"
echo "      ‚îî‚îÄ‚îÄ localhost:6379"
echo ""
echo "üéØ ERSTE SCHRITTE:"
echo "   1. Browser √∂ffnet automatisch auf http://localhost:5173"
echo "   2. Audio-Datei per Drag & Drop hochladen"
echo "   3. Transcription startet automatisch"
echo "   4. Ergebnis wird in Real-time angezeigt"
echo ""

if [[ $DEBUG_ENABLED == true ]]; then
    echo "üêõ DEBUG-BEFEHLE:"
    echo "   Live-Logs:        docker-compose logs -f"
    echo "   Service-Status:   docker-compose ps"
    echo "   Container-Shell:  docker-compose exec <service> sh"
    echo "   Resource-Usage:   docker stats"
    echo ""
fi

echo "üìä SERVICE-MANAGEMENT:"
echo "   View logs:     docker-compose logs -f"
echo "   Stop all:      docker-compose down"
echo "   Restart:       docker-compose restart"
echo "   Shell access:  docker-compose exec <service> sh"
echo ""
echo "üîß Development features:"
echo "   ‚úÖ Hot reload enabled for all services"
echo "   ‚úÖ Volume mounts for live code editing"
echo "   ‚úÖ Health checks for service monitoring"
echo "   ‚úÖ Automatic cleanup and restart on failures"
echo ""

# Optional: Pausiere vor Browser-√ñffnung im Debug-Modus
if [[ $DEBUG_ENABLED == true ]]; then
    echo ""
    echo "‚è∏Ô∏è  Debug Mode: Press Enter to continue to browser..."
    read
fi

# Browser automatisch √∂ffnen
echo "üåê Browser wird ge√∂ffnet..."
sleep 3
open http://localhost:5173

echo ""
echo "üîÑ VoxFlow l√§uft im Hintergrund..."
echo "üõë Services stoppen: docker-compose down"
echo "üìä Live-Logs anzeigen: docker-compose logs -f"
echo ""
echo "üí° Terminal offen lassen f√ºr Service-Management"
echo "üö™ Zum Beenden: Ctrl+C oder Terminal schlie√üen"
echo ""

# Terminal interaktiv halten
while true; do
    echo "W√§hle eine Option:"
    echo "  [l] Live-Logs anzeigen"
    echo "  [s] Service-Status pr√ºfen" 
    echo "  [r] Services neu starten"
    echo "  [q] Services stoppen & beenden"
    echo ""
    read -p "Option (l/s/r/q): " choice
    
    case $choice in
        l|L) docker-compose logs -f ;;
        s|S) docker-compose ps ;;
        r|R) docker-compose restart ;;
        q|Q) docker-compose down && echo "‚úÖ VoxFlow gestoppt" && exit 0 ;;
        *) echo "Ung√ºltige Option" ;;
    esac
    echo ""
done